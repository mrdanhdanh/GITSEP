<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
  <title></title>
    <link href="css/ext-theme-neptune-all-debug.css" type="text/css" rel="stylesheet">
    <link href="css/writer.css" type="text/css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Roboto&subset=latin,vietnamese' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="javascript/ext-all.js"></script>
    <script src="javascript/jquery-2.1.1.min.js"></script>
    <script src="javascript/jquery.ba-resize.min.js"></script>
    <script src="javascript/highcharts/highcharts.js"></script>
    <script src="javascript/highcharts/highcharts-more.js"></script>
    <script src="javascript/highcharts/no-data-to-display.js"></script>
    <script src="javascript/highcharts/exporting.js"></script>
    <script src="javascript/ext.js"></script> <!-- Script chính cho viewport và các thành phần khác --> 
    <script>
             
//Phần code cho chart và các hiệu ứng
//Tạo options cho chart

options = {
    chart: {
        zoomType: 'x',
        style: {fontFamily: 'Roboto'},
        selectionMarkerFill: 'rgba(151, 224, 135, 0.25)',
        resetZoomButton: {
                position: {
                    // align: 'right', // by default
                    // verticalAlign: 'top', // by default
                    x: -10,
                    y: 80
                },
                relativeTo: 'chart',
                theme: {
                    fill: 'white',
                    stroke: 'silver',
                    r: 5,
                    states: {
                        hover: {
                            fill: '#00a512',
                            style: {
                                color: 'white'
                            }
                        }
                    }
                }
        }
    },
    
    credits: {
        enabled: true,
        href: 'ext.html',
        text: 'SEP'
    },
    title: {
        text: 'Nồng độ theo thời gian'
    },
    subtitle: {
        text: 'Ngày tháng năm'
    },
    xAxis: {
        type: 'datetime',
        dateTimeLabelFormats: {
	millisecond: '%H:%M:%S.%L',
	second: '%H:%M:%S',
	minute: '%H:%M',
	hour: '%H:%M',
	day: '%e. %b',
	week: '%e. %b',
	month: '%b \'%y',
	year: '%Y'
},
        title: {
            text: 'Thời gian'
        }
    },
    yAxis: {
        title: {
            text: 'Nồng độ'
        },
        plotLines: [{
            value: 0,
            color: 'red',
            width: 2,
            zIndex: 4,
            label: {
                text: 'Qui chuẩn Việt Nam: Không quy định',
                align: 'left',
                style: {
                    color: 'red'
                }
            }  
        }]
    },
    
    tooltip:{
            shared: true,
            hidDelay: 300,
            borderRadius: 10
        },
    legend: {
        enabled: false
    },
    exporting: {
        enabled: true
    },
    plotOptions: {
        boxplot:{
            groupPadding: 0,
            medianColor: '#FF0000',
            lineWidth: 1,
            pointWidth: 10,
            color: '#00B050',
            stemColor: '#A9D18E',
            stemDashStyle: 'dot',
            whiskerColor: '#7030c0',
            whiskerLength: '100%',
            whiskerWidth: 3
        },
        spline: {
            allowPointSelect: true,
            marker: {
                enabled: true,
                states: {
                    select: {
                        fillColor: '#25e57b',
                        lineColor: '#25e57b',
                        lineWidth: '3px'
                    }
                }
            },
            events:{
                mouseOut: function(){
                    if (Ext.getCmp('view').getValue()=='h') {
                        rect.destroy();
                            text.destroy();
                        if (maxaqi24h<=50) {fillcolor='rgb(0, 177, 255)';strokecolor='rgba(0, 177, 255, 0.75)';textcolor='#000000';}
                        else if (maxaqi24h<=100) {fillcolor='rgb(255, 255, 0)';strokecolor='rgba(255, 255, 0, 0.75)';textcolor='#000000';}
                        else if (maxaqi24h<=200) {fillcolor='rgb(255, 167, 0)';strokecolor='rgba(255, 167, 0, 0.75)';textcolor='#000000';}
                        else if (maxaqi24h<=300) {fillcolor='rgb(255, 0, 0)';strokecolor='rgba(255, 0, 0, 0.75)';textcolor='#ffffff';}
                        else {fillcolor='rgb(162, 92, 3)';strokecolor='rgb(162, 92, 3, 0.75)';textcolor='#ffffff';}
        var chart=$('#chart-innerCt').highcharts();
        text = chart.renderer.text(
                'AQI (24h) = '+Math.round(maxaqi24h)+' ('+subname24h+')', 
                chart.plotLeft + 50, 
                chart.plotTop + 30
            ).attr({
                zIndex: 5
            }).css({
                color: textcolor,
                fontSize: '16px'
            }).add();
        
        var box = text.getBBox();
        rect=chart.renderer.rect(box.x - 5, box.y - 5, box.width + 10, box.height + 10, 0)
            .attr({
                fill: fillcolor,
                stroke: strokecolor,
                'stroke-width': 1,
                zIndex: 4
            })
            .add();
                    }}
            },
            point: {
                events: {
                    click: function(){
                        var grid = Ext.getCmp('mygrid');
                        var store=Ext.getStore('store');
                        var rowid=getId(this.x);
                        var page=store.getPageFromRecordIndex(rowid);
                        var row=rowid-((page-1)*itemsPerPage);
                        store.loadPage(page);
                        grid.getView().focusRow(row);
                    },
					mouseOver: function(){
						if (Ext.getCmp('view').getValue()=='h') {
                        var grid = Ext.getCmp('mygrid');
                        var store=Ext.getStore('store');
                        var rowid=getId(this.x);
                        var page=store.getPageFromRecordIndex(rowid);
                        var row=rowid-((page-1)*itemsPerPage);
						var data=store.proxy.data[row];
						var maxaqi1h=0;
                        var subname=null;
						for (var i=0;i<=4;i++) {
							var sub=haveqcvn[i];
							if (arrayqcvn[sub]['klr']==0) {stand=arrayqcvn[sub]['avg_1h'];}
								else if (unit[sub-1]=='ppm') {
									stand=arrayqcvn[sub]['avg_1h']/arrayqcvn[sub]['klr']*24.45/1000;
									} else stand=arrayqcvn[sub]['avg_1h']/arrayqcvn[sub]['klr']*24.45;
							if (i==4) stand=300;
                            if (maxaqi1h!=Math.max(data[(sub-1)*6+ex]/stand*100,maxaqi1h)) {
                                maxaqi1h=Math.max(data[(sub-1)*6+ex]/stand*100,maxaqi1h);
                                subname=arrayqcvn[sub]['name'];
                            }
							
						}
						if (maxaqi1h<=50) {fillcolor='rgb(0, 177, 255)';strokecolor='rgba(0, 177, 255, 0.75)';textcolor='#000000';}
                        else if (maxaqi1h<=100) {fillcolor='rgb(255, 255, 0)';strokecolor='rgba(255, 255, 0, 0.75)';textcolor='#000000';}
                        else if (maxaqi1h<=200) {fillcolor='rgb(255, 167, 0)';strokecolor='rgba(255, 167, 0, 0.75)';textcolor='#000000';}
                        else if (maxaqi1h<=300) {fillcolor='rgb(255, 0, 0)';strokecolor='rgba(255, 0, 0, 0.75)';textcolor='#ffffff';}
                        else {fillcolor='rgb(162, 92, 3)';strokecolor='rgb(162, 92, 3, 0.75)';textcolor='#ffffff';}
                            rect.destroy();
                            text.destroy();
						var chart=$('#chart-innerCt').highcharts();
                        var time=parseInt(data[1].substr(0,2));
        text = chart.renderer.text(
                'AQI ('+time+'h - '+(time+1)+'h) = '+Math.round(maxaqi1h)+' ('+subname+')', 
                chart.plotLeft + 50, 
                chart.plotTop + 30
            ).attr({
                zIndex: 5
            }).css({
                color: textcolor,
                fontSize: '16px'
            }).add();
        
        var box = text.getBBox();
        rect=chart.renderer.rect(box.x - 5, box.y - 5, box.width + 10, box.height + 10, 0)
            .attr({
                fill: fillcolor,
                stroke: strokecolor,
                'stroke-width': 1,
                zIndex: 4
            })
            .add();
					}
                }
                    
                }
                
            },
            cursor: 'pointer',
            turboThreshold: 100
        },

    },
    series: [{
	        name: 'Boxplot',
            type: 'boxplot',
	        data: [
	            [Date.UTC(2013, 1, 7),760, 801, 848, 895, 965],
	            [Date.UTC(2013, 1, 8),733, 853, 939, 980, 1080],
	            [Date.UTC(2013, 1, 9),714, 762, 817, 870, 918],
	            [Date.UTC(2013, 1, 10),724, 802, 806, 871, 950],
	            [Date.UTC(2013, 1, 11),834, 836, 864, 882, 910]
	        ],
	        tooltip: {
	            headerFormat: '<em>Thời gian: {point.key}</em><br/>'
	        }
	    }, {
	        name: 'Trung bình',
	        type: 'spline',
            id: 'line',
	        data: [ // x, y positions where 0 is the first category
                [Date.UTC(2013, 1, 7),796],
	            [Date.UTC(2013, 1, 8),763],
	            [Date.UTC(2013, 1, 9),817],
	            [Date.UTC(2013, 1, 10),754],
	            [Date.UTC(2013, 1, 11),864]
	        ],
	        
	        tooltip: {
	            pointFormat: '<span style="color:{series.color}">\u25CF</span> <b>{series.name}</b>: {point.y}'
	        }
	    }],
    lang: {
        noData: "Không có số liệu theo yêu cầu"
    },
    noData: {
        style: {
            fontWeight: 'bold',
            fontSize: '20px',
            color: '#303030'
        }
    }
};
</script>
    <script>
        // Các function khác
		ex=0; //Biến số cộng thêm để lấy data từ store.proxy
    unit=['ppm','ppm','ppb','ppb','ppb','ppb','ppm','ppb','ug/Nm3'];
    haveqcvn=[4,6,7,8,9];
	arrayqcvn = {
4:{'name':'NO2','avg_1h':200,'avg_24h':100,'avg_1y':40,'klr':46},
6:{'name':'O3','avg_1h':200,'avg_24h':0,'avg_1y':0,'klr':48},
7:{'name':'CO','avg_1h':30000,'avg_24h':0,'avg_1y':0,'klr':28},
8:{'name':'SO2','avg_1h':350,'avg_24h':125,'avg_1y':50,'klr':64},
9:{'name':'PM2.5','avg_1h':0,'avg_24h':50,'avg_1y':25,'klr':0}
};
    function showdata(subs){
        options.series[0].data=[];
        options.series[1].data=[];
        var data=Ext.getStore('store').proxy.data;
        var date=Ext.getCmp('date').getSubmitValue();
        options.yAxis.title.text= 'Nồng độ ('+unit[subs-1]+')';
        options.title.text='Nồng độ '+Ext.getCmp('subs').getStore().data.items[subs-1].data.name+' theo thời gian';
        options.subtitle.text='Ngày '+date.substr(8,2)+' tháng '+date.substr(5,2)+' năm '+date.substr(0,4);
        
        
        if (haveqcvn.indexOf(subs)>=0) {
            switch(Ext.getCmp('view').getValue()) {
	case 'h':
        view='avg_1h';
        break;
    case 'd':
        view='avg_24h';
        break;
    default:
		view=null;
}
			if (view!=null && arrayqcvn[subs][view]!=0) {
				if (arrayqcvn[subs]['klr']==0) {qcvn=arrayqcvn[subs][view];}
				else if (unit[subs-1]=='ppm') {
					qcvn=arrayqcvn[subs][view]/arrayqcvn[subs]['klr']*24.45/1000;
					} else qcvn=arrayqcvn[subs][view]/arrayqcvn[subs]['klr']*24.45;
			} else qcvn=0;
        }
        else qcvn=0;
		if (qcvn==0) {
            options.yAxis.plotLines[0].value=0;
            options.yAxis.plotLines[0].label.text='Qui chuẩn Việt Nam: Không qui định';
        } else {
			options.yAxis.plotLines[0].value=qcvn;
            options.yAxis.plotLines[0].label.text='Qui chuẩn Việt Nam: '+(Math.round(qcvn * 1000) / 1000)+' '+unit[subs-1];
		}
        if (data.length!=0){
            if (Ext.getCmp('view').getValue()=='d') {
                ex=1;
                var col = (subs-1)*6 + ex;
                for (var i=0;i<data.length;i++) {
            var jyea=data[i][0].substr(0,4);
            var jmon=data[i][0].substr(5,2)-1;
            var jday=data[i][0].substr(8,2);
            options.series[0].data.push([Date.UTC(jyea,jmon,jday),data[i][col+1],data[i][col+2],data[i][col+3],data[i][col+4],data[i][col+5]]);  
            options.series[1].data.push({x:Date.UTC(jyea,jmon,jday),y:data[i][col]});
                    if (data[i][col]<0 || data[i][col]>500) options.series[1].data[i].color='red';
            };
            $('#chart-innerCt').highcharts(options); }
            else {
                ex=2;
                var col = (subs-1)*6 + ex;
        for (var i=0;i<data.length;i++) {
            var jyea=data[i][0].substr(0,4);
            var jmon=data[i][0].substr(5,2)-1;
            var jday=data[i][0].substr(8,2);
            var jhou=data[i][1].substr(0,2);
            var jmin=data[i][1].substr(3,2);
            var jsec=data[i][1].substr(6,2);
            options.series[0].data.push([Date.UTC(jyea,jmon,jday,jhou,jmin,jsec),data[i][col+1],data[i][col+2],data[i][col+3],data[i][col+4],data[i][col+5]]);
            options.series[1].data.push({x:Date.UTC(jyea,jmon,jday,jhou,jmin,jsec),y:data[i][col]});
            if (data[i][col]<0 || data[i][col]>500) options.series[1].data[i].color='red';

        };
              if (Ext.getCmp('view').getValue()=='h') {drawchartaqi();}
            else $('#chart-innerCt').highcharts(options);}        
        } else $('#chart-innerCt').highcharts(options);
    }
    function drawchartaqi(){
		var maxavg1h=[0,0,0,0,0];
		var avg24h=[0,0,0,0,0];
        subname24h=null;
        maxaqi24h=0;
		for (var i=0;i<=4;i++) {
            
			for (var y=0;y<store.proxy.data.length;y++) {
                var value=store.proxy.data[y][(haveqcvn[i]-1)*6+ex];
				maxavg1h[i]=Math.max(maxavg1h[i],value);
                avg24h[i]=avg24h[i]+value;
			}
            avg24h[i]=avg24h[i]/store.proxy.data.length;
            var sub=haveqcvn[i];
							if (arrayqcvn[sub]['klr']==0) {
                                stand1h=arrayqcvn[sub]['avg_1h'];
                                stand24h=arrayqcvn[sub]['avg_24h'];
                            }
								else if (unit[sub-1]=='ppm') {
                                    stand1h=arrayqcvn[sub]['avg_1h']/arrayqcvn[sub]['klr']*24.45/1000;
                                    stand24h=arrayqcvn[sub]['avg_24h']/arrayqcvn[sub]['klr']*24.45/1000;
                                } else {
                                    stand1h=arrayqcvn[sub]['avg_1h']/arrayqcvn[sub]['klr']*24.45;
                                    stand24h=arrayqcvn[sub]['avg_24h']/arrayqcvn[sub]['klr']*24.45;
                                }
							if (i==4) stand1h=300;
            var tam=maxaqi24h;
            if (stand24h==0) {maxaqi24h=Math.max(maxavg1h[i]/stand1h*100,maxaqi24h);}
            else maxaqi24h=Math.max(maxavg1h[i]/stand1h*100,avg24h[i]/stand24h*100,maxaqi24h);
            if (tam!=maxaqi24h) subname24h=arrayqcvn[sub]['name'];
		}
        if (maxaqi24h<=50) {fillcolor='rgb(0, 177, 255)';strokecolor='rgba(0, 177, 255, 0.75)';textcolor='#000000';}
                        else if (maxaqi24h<=100) {fillcolor='rgb(255, 255, 0)';strokecolor='rgba(255, 255, 0, 0.75)';textcolor='#000000';}
                        else if (maxaqi24h<=200) {fillcolor='rgb(255, 167, 0)';strokecolor='rgba(255, 167, 0, 0.75)';textcolor='#000000';}
                        else if (maxaqi24h<=300) {fillcolor='rgb(255, 0, 0)';strokecolor='rgba(255, 0, 0, 0.75)';textcolor='#ffffff';}
                        else {fillcolor='rgb(162, 92, 3)';strokecolor='rgb(162, 92, 3, 0.75)';textcolor='#ffffff';}
        $('#chart-innerCt').highcharts(options);
        var chart=$('#chart-innerCt').highcharts();
        text = chart.renderer.text(
                'AQI (24h) = '+Math.round(maxaqi24h)+' ('+subname24h+')', 
                chart.plotLeft + 50, 
                chart.plotTop + 30
            ).attr({
                zIndex: 5
            }).css({
                color: textcolor,
                fontSize: '16px'
            }).add();
        
        var box = text.getBBox();
        rect=chart.renderer.rect(box.x - 5, box.y - 5, box.width + 10, box.height + 10, 0)
            .attr({
                fill: fillcolor,
                stroke: strokecolor,
                'stroke-width': 1,
                zIndex: 4
            })
            .add();
        
    }
    function getId(value){  
        var ar=options.series[0].data;
        for (var i=0;i<ar.length;i++){
            if (ar[i][0]==value || ar[i].x==value) break;
        }
        return i;
    }
        window.onload = function(){ setTimeout(
            function(){
                $('#chart-innerCt').highcharts(options);
                $('#chart-innerCt').resize(function(){
                    $('#chart-innerCt').highcharts().reflow();
                });
            }
            , 300); };

        
                                
    </script>
</head>

<body>
</body>
</html>